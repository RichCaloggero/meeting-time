<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Meeting Time</title>
<link rel="shortcut icon" href="#" type="image/x-icon">
</head>
<body>
<h1>Meeting Time</h1>

<nav><ul><li>
<button data-action="new-meeting" aria-pressed="false" accesskey="c">New meeting</button>
</li><li>
<button data-action="update-meeting" aria-pressed="false" accesskey="u">Update meeting</button>
</li><li>
<button data-action="delete-meeting" aria-pressed="false" accesskey="d">Delete meeting</button>
</li></ul>

<main>
</main>

<output id="status"></output>

<script>
const origin = "";
const $nav = $("nav");
const $main = $("main");
const $status = $("#status");
const actions = {
"new-meeting": newMeeting,
"update-meeting": updateMeeting,
"delete-meeting": deleteMeeting,
"save-meeting-data": saveMeetingData,
"load-meeting-data": loadMeetingData,
"add-proposal": addProposal,
"delete-proposal": deleteProposal,
"find-meeting": findMeeting,
"vote": vote,
}; // actions

const meetings = new Map();

meetings.set("test0", {
id: "test0",
info: "some info",
proposals: [
{voteCount: 2, timestamp: toTimestamp("2024-07-10", "12:00:00")},
{voteCount: 1, timestamp: toTimestamp("2024-07-10", "11:00:00")}
]});


const meetingTemplate = `<div>
<label>Meeting ID (save this for later): <input class="meeting-id" name="meeting-id" readonly></label>
</div>

<div><label>Meeting info:<br>
<textarea required class="meeting-info" name="meeting-info" rows="5" cols="80"></textarea>
</div>

<h3>Current proposals</h3>
<table class="proposals"><tr>
<th>vote</th>
<th>count</th>
<th>date</th>
<th>time</th>
</tr></table>

<fieldset class="new-proposal"><legend><h3>New proposal</h3></legend>
<label>Date: <input id="date" name="date" type="date" id="proposal-date"></label>
<br><label>Time: <input id="time" name="time" type="time" id="proposal-time"></label>
<br><button data-action="add-proposal" type="button">Add proposal</button>
</fieldset>
`; // meetingTemplate

/// connect to server

let clientID = 0;
const server = new EventSource(`${origin}/events`);

server.addEventListener("open", e => {
//console.log("connecting...");
statusMessage("Connecting ...")
});

server.addEventListener("connected", e => {
const data = JSON.parse(e.data);
clientID = data.id;
loadAllMeetings(data.meetings, meetings);
document.addEventListener("click", performAction);
statusMessage("connected.");
if (isUpdateRequest()) updateMeeting();
}); // connected

server.addEventListener("update", e => {
data = JSON.parse(e.data);
//console.log("update: ", data);
meetings.set(data.meeting.id, data.meeting);
if (isUpdateMode() && $("form")["meeting-id"].value === data.meeting.id) merge(data.meeting);
}); // update

server.onerror = e => statusMessage(`error from server:\n${e}`);


function loadAllMeetings (list, map) {
for (const meeting of list) {
map.set(meeting.id, meeting);
} // for
} // loadAllMeetings


function performAction (e) {
const $action = e.submitter || e.target;
const actionId = $action.dataset.action;
const $form = $action.closest("form");

if ($action.hasAttribute("aria-pressed")) {
if ($action.getAttribute("aria-pressed") === "true") return;
resetNavigation();
$action.setAttribute("aria-pressed", "true");
} // if

const action = actions[actionId];
//console.log("action: ", actionId, action);
if (not(action)) return; // fail silently

action({$action, $form, update: getUpdateRequest()});
} // performAction


/// actions

function newMeeting () {
clearForm();
meetingId = generateMeetingId();

$("main").insertAdjacentHTML("afterBegin",
`<form id="new-meeting" method="post">
${meetingTemplate}

<button data-action="save-meeting-data" type="button">Submit</button>
`);

$("main #new-meeting [name=meeting-id]").value = meetingId;
$("main #new-meeting [name=meeting-id]").focus();
} // newMeeting

function updateMeeting () {
clearForm();

$("main").insertAdjacentHTML("afterBegin", 
`<form id="update-meeting">
${meetingTemplate}

<button data-action="save-meeting-data" type="button">Submit</button>
</form>
`);

if (isUpdateRequest()) {
$("form")["meeting-id"].value = getUpdateRequest();
if (not(findMeeting())) return;

} else {
$("form [name=meeting-id").removeAttribute("readonly");
$("form [name=meeting-id").insertAdjacentHTML("afterEnd",
`<button data-action="find-meeting" type="button">Find meeting</button>
`);
} // if


$("form")["meeting-info"].focus();
} // updateMeeting

function deleteMeeting () {
} // deleteMeeting

function addProposal () {
const $proposal = $("form .new-proposal");
const date = $(".new-proposal #date").value;
const time = $(".new-proposal #time").value;
const timestamp = toTimestamp(date, time);
const meeting = meetings.get(valueOf("meeting-id")[0]);

if (meeting.proposals.find(p => p.timestamp === timestamp)) {
statusMessage("timeslot already proposed.");
return;
} // if

const proposal = {
timestamp, voteCount: 1,
};

const proposalCount = $$get("proposal").length;

$("form .proposals").insertAdjacentHTML("beforeEnd", createProposal(proposal, proposalCount+1));
saveMeetingData();
} // addProposal

function createProposal (proposal, count) {
const {timestamp, voteCount} = proposal;
const d = new Date(timestamp);
const date = d.toLocaleDateString();
const time = d.toLocaleTimeString();

const dateLabel = `date-${count}`;
const timeLabel = `time-${count}`;

return `<tr class="proposal">
<!--<td><input type="checkbox" data-action="vote" aria-labelledby="${dateLabel} ${timeLabel}"></td>
-->
<td><input type="checkbox" data-action="vote"
aria-label="${createLabel(voteCount, date, time)}">
</td>

<td><output class="vote-count">${proposal.voteCount}</output></td>
<td class="date" id="${dateLabel}">${date}</td>
<td class="time" id="${timeLabel}">${time}</td>
</tr>`; // proposal
} // createProposal

function createLabel (voteCount, date, time) {
return `currently ${voteCount} votes for ${time}, on ${date}`;
} // createLabel

function deleteProposal ($button, $form) {
$proposal = $button.closest(".proposal");
if (not($proposal)) return;
$proposal.remove();
proposalCount -= 1;
} // deleteProposal

function saveMeetingData () {
const $proposals = $("form .proposals");

const meeting = {};

meeting.id = valueOf("meeting-id")[0];
meeting.info = valueOf("meeting-info")[0];
meeting.proposals = $$get("proposal")
.map($p => {
return {
voteCount: voteCount($p),
timestamp: toTimestamp(date($p), time($p))
};
}); // map

meetings.set(meeting.id, meeting);
sendMeetingData(meeting);
} // saveMeeting

function findMeeting () {
$meetingId = $("form")["meeting-id"];

if (not(meetings.has($meetingId.value))) {
statusMessage("invalid meeting ID");
$meetingId.focus();
return false;
} // if

loadMeetingData(meetings.get($meetingId.value));
$("form")["meeting-info"].focus();
return true;
} // findMeeting

function vote (data) {
$action = data.$action; // the specific checkbox

const $proposal = $action.closest(".proposal");
$count = $(".vote-count", $proposal);
$count.value = $action.checked?
Number($count.value) + 1
: Number($count.value) - 1;
$action.setAttribute("aria-label", createLabel($count.value, date($proposal), time($proposal)));
} // vote

/// utilities

function loadMeetingData (data) {
$$get("meeting-info")[0].value = data.info;

$proposals = $$get("proposals")[0];

let proposalCount = 0;
for (proposal of data.proposals.sort(orderByVoteCount)) {
proposalCount += 1;
$proposals.insertAdjacentHTML("beforeEnd", createProposal(proposal, proposalCount));
} // for

function orderByVoteCount (p1, p2) {
const n1 = p1.voteCount, n2 = p2.voteCount;
return n1 < n2? 1 // largest first
: n1 > n2? -1
: 0;
} // orderByVoteCount
} // loadMeetingData

function resetNavigation () {
document.querySelectorAll("nav [aria-pressed]")
.forEach(x => x.setAttribute("aria-pressed", "false"));
} // resetNavigation


function clearForm () {
$("main").innerHTML = "";
} // clearForm


function generateMeetingId () {
return btoa(Math.random());
} // generateMeetingId

function isUpdateRequest () {
const url = new URL(location);
return url.searchParams.has("update");
} // isUpdateRequest

function getUpdateRequest () {
return isUpdateRequest()?
new URL(location).searchParams.get("update") : "";
} // getUpdateRequest

function isUpdateMode () {
return $("form#update-meeting");
} // isUpdateMode

function merge (data) {
statusMessage("someone else updated this meeting - reloading (changes may be lost)");
$$get("proposals")[0].innerHTML = "";
loadMeetingData(data);
} // merge

function integrateMeetingData (data) {
$("form")["meeting-info"].value = data.info;

for (proposal of data.proposals) {
const $proposal =  findProposal($$("form .proposal"), data.date, data.time);
if ($proposal && $("input", $proposal).checked) proposal.voteCount += 1;
} // for
$("form .proposals").innerHTML = "";

loadMeetingData(data);
} // integrateMeetingData

function findProposal (list, date, time) {
if (list[0].matches("tr")) return list.find(
$tr => $(".date", $tr).textContent === date
&& $(".time", $tr).textContent === time
);
else return list.find(
p => p.date === date && p.time === time
);
} // findProposal

function statusMessage (text) {
setTimeout(() => $("#status").textContent = text, 200);
} // statusMessage

/// accessors

function $$get(selector) {
const elements = $$(`form ${selector}`);
return elements && elements.length > 0?
elements : $$(`form .${selector}`);
} // $$get

function valueOf (selector) {
return $$get(selector)
.map(x => x.value || x.textContent);
} // valueOf
function date ($proposal) {
return $proposal.matches("#new-proposal")?
$("#date", $proposal).value : $(".date", $proposal).textContent;
} // date

function time ($proposal) {
return $proposal.matches("#new-proposal")?
$("#time", $proposal).value : $(".time", $proposal).textContent;
} // date

function voteCount ($proposal) {return Number($(".vote-count", $proposal).textContent);}

function toTimestamp (date, time) {
return Date.parse(`${date} ${time}`);
} // toTimestamp

function toDate(timestamp) {return new Date(timestamp).toLocaleDateString();} // toDate
function toTime(timestamp) {return new Date(timestamp).toLocaleTimeString();} // toDate

function $ (s, c = document) {return c.querySelector(s);}
function $$ (s, c = document) {return [...c.querySelectorAll(s)];}

function not (x) {return !x;}

/// server stuff

async function sendMeetingData (meeting) {
//console.log("sendMeetingData(): ", clientID, meeting);
if (clientID === 0) {
statusMessage("Connection to server not established.");
return;
} // if

try {
const res = await fetch(`${origin}/data`, {
method: "POST", 
//mode: "cors",
headers: {
'Accept': 'application/json',
'Content-Type': 'application/json',
"Cache-Control": "no-cache"
},
//"origin-when-cross-origin": true,
body: JSON.stringify({clientID: clientID, meeting})
}); // fetch


//console.log("fetch succeeded");

const responseData = await res.json();
//console.log("response data: ", responseData);

} catch (e) {
statusMessage(`fetch failed.\n${e.message}`);
} // try
} // sendMeetingData



</script>
</body>
</html>
